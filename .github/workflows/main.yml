# This is a basic workflow to help you get started with iCR CI/CD
name: Openrefactory_CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "master" branch
  push:
    branches: [ "master" ]

env:
  # Registry configuration
  REGISTRY: ghcr.io

jobs:
  OR_JOB:
    runs-on: ubuntu-latest # Use GitHub-hosted runners
    container:
      image: ghcr.io/testingxor/icr-github:latest # Ensure this image is compatible with your environment
      
    steps:
      # Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v2 

      # Validate and update GLIBC
      - name: Validate and Update GLIBC
        run: |
          echo "Checking GLIBC version..."
          current_version=$(ldd --version | head -n 1 | awk '{print $NF}')
          required_version="2.28"
          
          if [ "$(printf '%s\n' "$required_version" "$current_version" | sort -V | head -n1)" != "$required_version" ]; then
            echo "Updating GLIBC to version $required_version..."
            apt-get update && apt-get install -y software-properties-common
            add-apt-repository -y ppa:ubuntu-toolchain-r/test
            apt-get update && apt-get install -y libc6
          else
            echo "GLIBC is up-to-date (Version: $current_version)"
          fi

      # Run the OpenRefactory job
      - name: Run OR Job
        run: |
          /workspace/configure_run.sh ${{ github.ref_name }} \
          ${{ github.repositoryUrl }} \
          ${{ secrets.ICR_URL }} \
          ${{ secrets.ICR_USER_NAME }} \
          ${{ secrets.ICR_CI_CD_ACCESS_TOKEN }} \
          ${{ secrets.PERSONAL_ACCESS_TOKEN }} \
          ${{ secrets.MAIL_ADDRESS }} \
          ${{ secrets.LANGUAGE }} \
          ${{ secrets.LANGUAGE_VERSION }} 
        shell: bash
